---
### Crafts and tests
## Prevents me from commenting/uncommenting/forgetting on final production files ^^'
# > ansible-playbook -i hostsWithCustomSSHPort 99-craft-and-tests.yml

# ---
# Currently working on: creating a stfp user per client
# Based on ansible\2-generate-users-and-change-ssh-port.yml

# ---

# You'll need the_builder_guy to have it's ssh key added to the local agent, cf. the_builder_guy generated documentation
# You'll need the_docker_guy to have it's ssh key added to the local agent, cf. the_docker_guy generated documentation

# ---

### Setup sftp user
##    Notes: https://github.com/youpiwaza/server-related-tutorials/tree/master/04-user-restrict-and-sftp
# - Create dedicated user
#   - âœ… Use role or wtv but needs auth keyz
#   - âœ… name : CLIENT---DASHED-URI
#   - âœ… Create chroot folder, with proper âœ…location/âœ…rights/âœ…own + move âœ….ssh/ & .cache/ + âœ…README.md
#   - âœ… Remove original home folder
#   - âœ… usermod: âœ… group, âœ… shell nologin, âœ… new home folder
#   - 
#   - âœ… Create home/my-stuff folder, with proper location/rights/own + README.md
#   - âœ… Generate user README.md ansible-install-web-server\ansible\roles\users\templates\ssh-users-manual-commands.md.j2
#   - âœ… Refaire README.md avec tuto images etc. pour connexion via filezillah
#   - âœ… AdaptÃ© au projet
#   - âœ… include dans âœ… nginx & ðŸš€ wp
#   - 
#   - âœ… It works

# the_builder_guy
- name: Crafts and tests / Creating a stfp user per client
  hosts: likorneWithCustomSSHPort
  # the_builder_guy / cf. /ansible/roles/users/vars/main.yml
  remote_user: '{{ users.0.name }}'
  become: yes
  vars_files:
  - defaults/main.yml
  - roles/users/defaults/main.yml
  - vars/main.yml
  - roles/users/vars/main.yml
  vars:
    currentDateTime: "{{ ansible_date_time.date }}--{{ ansible_date_time.hour }}h{{ ansible_date_time.minute }}m{{ ansible_date_time.second }}s"
    ## Role variable overload (there's a if in the role), don't use {{ users }} as it won't overload
    newUser:
      # 'Member CLIENT_NAME---DASHED-URI
      - name: bobby
        allowCron: no
        dockerManagement: no
        mail: masamune.code@gmail.com
        preventHomeAccess: no
        restrictUser: no
        # ssh_passphrase: 'bonjour'
        ssh_passphrase: "{{ lookup('password', './generated/{{ project.type }}s/{{ project.client_name }}/{{ project.dashed_domain }}/vars-files/SFTP_PASSPHRASE-generated.txt length=32') }}"
        sudoer: no
    project:
      type: 'test'
      client_name: 'masamune'
      dashed_domain: 'standalone-sftp-user'

  roles:
    - sftp-create-user
    # - sftp-remove-user

  # tasks:
  #   - name: Setup chroot prison
  #     include_role:
  #       name: users
  #       tasks_from: setup-chroot-prison
...