---
### Crafts and tests
## Prevents me from commenting/uncommenting/forgetting on final production files ^^'
# > ansible-playbook -i hostsWithCustomSSHPort 99-craft-and-tests.yml

# ---
# Currently working on: creating a stfp user per client
# Based on ansible\2-generate-users-and-change-ssh-port.yml

# ---

# You'll need the_builder_guy to have it's ssh key added to the local agent, cf. the_builder_guy generated documentation
# You'll need the_docker_guy to have it's ssh key added to the local agent, cf. the_docker_guy generated documentation

# ---

# the_builder_guy
- name: Install my web server / Generate users and set custom SSH port
  hosts: likorneWithCustomSSHPort
  # the_builder_guy / cf. /ansible/roles/users/vars/main.yml
  remote_user: '{{ users.0.name }}'
  become: yes
  vars_files:
  - defaults/main.yml
  - roles/users/defaults/main.yml
  - vars/main.yml
  - roles/users/vars/main.yml
  vars:
    currentDateTime: "{{ ansible_date_time.date }}--{{ ansible_date_time.hour }}h{{ ansible_date_time.minute }}m{{ ansible_date_time.second }}s"
    ## Role variable overload (there's a if in the role)
    newUser:
      - name: bob
        allowCron: no
        dockerManagement: no
        mail: masamune.code@gmail.com
        preventHomeAccess: no
        restrictUser: no
        ssh_passphrase: 'bonjour'
        sudoer: no

  roles:
    - users

### Notes
# üö® Test without chroot tutorial : sftp login ko when using restrict-user.yml yes
# Needs BOTH a proper shell (!= rbash) & home folder not chowned by root:root

### Manual commands
# List ubuntu users > sudo cat /etc/passwd
# Remove ubuntu user > sudo userdel -r bob

## Tester chroot prison a la racine des utilisateurs, √† la main
## shaco
## Cr√©ation du r√©pertoire chroot
# sudo mkdir -p /test_chroot/
# sudo chown root:root /test_chroot/

### Cr√©ation de l'utilisateur / "Pas possible" de le faire √† la main pour cl√©s connexions SSH

## Vidanger utilisateur
## Local > C:\Users\Patolash\.ssh >> Virer bob*
# sudo userdel -r bob

## Cr√©er utilisateur AVEC connexion alakon
# Local > ansible-playbook -i hostsWithCustomSSHPort 99-craft-and-tests.yml
## Local > C:\Users\Patolash\.ssh\_filezilla sftp commeng.txt // Ajouter cl√© & tester connexion

## Changer le r√©pertoire home de l'utilisateur
# sudo mkdir -p /test_chroot/bob
# sudo chown bob:bob /test_chroot/bob/
# sudo chmod 700 /test_chroot/bob/

## Ne doit pas √™tre connect√© en m√™me temps !
# sudo usermod --home /test_chroot/bob bob
# // ^ connexion filezilla KO
# sudo rm -R /home/bob

## Changer son shell en nologin
# sudo usermod --shell /sbin/nologin bob
# 

## Configurer le ssh afin de mettre en place la prison chroot
# sudo nano /etc/ssh/sshd_config
#> Subsystem sftp  internal-sftp
#> 
#> Match User bob
#>    ChrootDirectory /test_chroot/
#>    ForceCommand internal-sftp
#>    X11Forwarding no
#>    AllowTcpForwarding no
## Tester la nouvelle configuration du ssh avant reboot
# sudo sshd -t
## Reboot ssh
# sudo systemctl restart sshd (OU ||) sudo service sshd restart

### Tester connexion via filezilla
## KO :'(
## Tests empiriques
# sudo chmod 777 /test_chroot/bob/      // nope
# sudo usermod --shell /bin/bash bob    // nope

## Restoration du shell & du r√©pertoire par d√©faut
# sudo mkdir /home/bob
# sudo chown bob:bob /home/bob
# sudo usermod --home /home/bob bob
## Toujours KO

## Restoration de la config sshd
# sudo nano /etc/ssh/sshd_config
#> # *
# sudo sshd -t
## Reboot ssh
# sudo systemctl restart sshd
## Toujours KO

### Script cr√©ation user >> ansible-install-web-server\ansible\roles\users\tasks\add-ssh-key.yml
### La cl√© est ajout√©e dans le r√©pertoire home de l'utilisateur dans le dossier (cach√©) /.ssh lelelel
# Local > ansible-playbook -i hostsWithCustomSSHPort 99-craft-and-tests.yml
## /home/bob/.ssh/ restaur√© > possibilit√© de se connecter



##### DU COUP
### M√™me chose en conservant .ssh/
# sudo cp -R /home/bob/ /test_chroot/
# sudo chown -R bob:bob /test_chroot/bob/
# sudo chmod -R 700 /test_chroot/bob/
# sudo usermod --home /test_chroot/bob bob
## Connexion toujours ok mais pas emprisonn√©
# sudo usermod --shell /sbin/nologin bob
## Connexion KO ^
# sudo usermod --shell /usr/bin/zsh bob
## Connexion re-OK
## Modif sshd_config..
## Test connexion > user arrive sur /   -_-"""""
## OK > L√©ger lag du au reboot du service sshd ?
## User bien bloqu√© dans /test_chroot/, ne peux pas remonter.
## Ne peux cr√©er des fichiers que dans /test_chroot/bob/
## MAIS il peut aussi modifier les droits des fichiers (~777 > executable)

## Shell > nologin
# sudo usermod --shell /sbin/nologin bob
## OK√©, mais droits toujours modifiables (fait partie du sftp apr√®s tout)

## Teste de goyer depuis le terminal
#> eval `ssh-agent` && ssh-add ~/.ssh/bob-ssh-key-ed25519
#> bonjour
#> sftp -P 6942 bob@188.165.253.170
#> // Lancement de script etc. >> Tout est KO en dehors de mkdir/touch/cd/chmod, c'est ok√©


##### Tester avec conf sshd dans fichier utilisateur d√©di√© plut√¥t que dans conf g√©n√©rale !
...