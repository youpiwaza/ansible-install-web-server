---
### Crafts and tests
## Prevents me from commenting/uncommenting/forgetting on final production files ^^'

# ---
# Currently working on: Playbook 4 / Init core services / Set up reverse proxy Traefik & hello world test
# ---

# You'll need the_builder_guy to have it's ssh key added to the local agent, cf. the_builder_guy generated documentation
# You'll need the_docker_guy  to have it's ssh key added to the local agent, cf. the_docker_guy  generated documentation

# ---

### TODO
## Local
# âœ… Manage required vars
# âœ… Generate a local README.md file w. vars
# âœ… Default vars overload template in test playbook
# âœ… Make a wordpress-stack.yml.j2 template file
#   âœ… docker guy host cli > remove stack 'test-wordpress' and test generated file
#   âœ… volumes are generated automatically w. stack ? no need to create FOR TEST (needs labels)
# âœ… Manage generated vars
#   ðŸš€ Prefix generated vars files with client_name-dashed_domain, as they will be needed to upgrade DImages without altering vars (lookup doesn't recreate)
# âœ… Generate a local wordpress-stack.yml file using vars, for debug purposes

## Builder guy
# âœ… Upload/template wordpress-stack.yml to host

## Docker guy
# Volumes creation
  ## Create named volumes
  # docker volume create \
  #    --label fr.masamune.test-wordpress.client='masamune' \
  #    --label fr.masamune.test-wordpress.maintainer='masamune.code@gmail.com' \
  #    --label fr.masamune.test-wordpress.project='test service wordpress > mariadb' \
  #    --label fr.masamune.test-wordpress.type='test' \
  #    test--test-wordpress-masamune-fr--wordpress--db \
  # && \
  # docker volume create \
  #    --label fr.masamune.test-wordpress.client='masamune' \
  #    --label fr.masamune.test-wordpress.maintainer='masamune.code@gmail.com' \
  #    --label fr.masamune.test-wordpress.project='test service wordpress > wordpress' \
  #    --label fr.masamune.test-wordpress.type='test' \
  #    test--test-wordpress-masamune-fr--wordpress--files
  ## ANSIBLE > {{ project.type }}--{{ project.dashed_domain }}--wordpress--db
# Debug warning: ~1min to start (database creation)
# Start stack
# Automated ~Manual steps (wp-cli, etc.)

# ---

### Setup a WordPress stack
# Based on bitnami's WordPress & MariaDB images
#   https://hub.docker.com/r/bitnami/wordpress/
#   https://hub.docker.com/r/bitnami/mariadb/

# You'll need the_builder_guy to have it's ssh key added to the local agent, cf. the_builder_guy generated documentation
# You'll need the_docker_guy  to have it's ssh key added to the local agent, cf. the_docker_guy  generated documentation

- name: 'Setup a WordPress stack'
  become: yes
  hosts: likorneWithCustomSSHPort
  # the_builder_guy / cf. /ansible/roles/users/vars/main.yml
  remote_user: '{{ users.0.name }}'
  vars:
    # Generate random strings with lookup, cf. https://github.com/youpiwaza/server-related-tutorials/tree/master/02-ansible/14-password-generation

    database:
      # image: 'bitnami/mariadb:10.3__overload_test'
      image: 'bitnami/mariadb:10.3'

      MARIADB_DATABASE: "{{ lookup('password', './tmp/MARIADB_DATABASE-generated.txt length=32 chars=ascii_letters,digits') }}"
      MARIADB_PASSWORD: "{{ lookup('password', './tmp/MARIADB_PASSWORD-generated.txt length=32 chars=ascii_letters,digits') }}"
      MARIADB_USER: "{{ lookup('password', './tmp/MARIADB_USER-generated.txt length=32 chars=ascii_letters,digits') }}"
      MARIADB_ROOT_PASSWORD: "{{ lookup('password', './tmp/MARIADB_ROOT_PASSWORD-generated.txt length=32 chars=ascii_letters,digits') }}"
      MARIADB_ROOT_USER: "{{ lookup('password', './tmp/MARIADB_ROOT_USER-generated.txt length=32 chars=ascii_letters,digits') }}"

    project:
      client_name: 'masamune'
      dashed_domain: 'test-wordpress-masamune-fr'
      # Docker recommanded notation: extension.site.subdomain.SOME-LABEL
      #   https://docs.docker.com/config/labels-custom-metadata/#key-format-recommendations
      labels_prefix: 'fr.masamune.test-wordpress'
      maintainer: 'masamune.code@gmail.com'
      name: 'test wordpress'
      type: 'test'

    traefik:
      # Ensure DNS are set accordingly to point towards host IP
      # This will point towards 'https://test-wordpress.masamune.fr/'
      public_uri: 'test-wordpress.masamune.fr'
      # For router & middleware names generation
      # subDomain_domain_ext__stacktype
      uid: 'testWordpress_masamune_fr__wordpress'

    wordpress:
      image: 'bitnami/wordpress:5'
      WORDPRESS_TABLE_PREFIX: "{{ lookup('password', './tmp/WORDPRESS_TABLE_PREFIX-generated.txt length=16 chars=ascii_letters,digits') }}"
      WORDPRESS_BLOG_NAME: "Sponge Bob's blog"
      WORDPRESS_EMAIL: 'masamune.code@gmail.com'
      WORDPRESS_FIRST_NAME: 'Bob'
      WORDPRESS_LAST_NAME: 'Sponge'
      # 50 chars length / NO SPECIAL CHARS, tends to not match when container is up
      WORDPRESS_USERNAME: "{{ lookup('password', './tmp/WORDPRESS_USERNAME-generated.txt length=50 chars=ascii_letters,digits') }}"
      # 50 chars length / Wordpress recommandations : ! ? % ^ & ) / No no $ ' :"
      WORDPRESS_PASSWORD: "{{ lookup('password', './tmp/WORDPRESS_PASSWORD-generated.txt length=50 chars=ascii_letters,digits,!,?,%,^,&,)') }}"
  vars_files:
  - defaults/main.yml
  - roles/users/defaults/main.yml
  - vars/main.yml
  - roles/users/vars/main.yml

  roles:
    - wordpress-generate
  
  # # Debug / Test generated variable disponibility & immutability
  # tasks:
  #   - name: 'Test generated variable disponibility & immutability'
  #     debug:
  #       msg: 'database.MARIADB_DATABASE : {{ database.MARIADB_DATABASE }}'
...